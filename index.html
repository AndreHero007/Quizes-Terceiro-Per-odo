<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-DJ6GXTCQNG"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-DJ6GXTCQNG');
  </script>
  <meta charset="UTF-8" />
  <title>Quiz - Múltipla Escolha, V ou F e Escrita</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #e3eeff 0%, #f7f4fd 100%);
      margin: 0;
      min-height: 100vh;
      padding: 0;
    }
    #container {
      max-width: 700px;
      margin: 36px auto 36px auto;
      padding: 32px 24px 28px 24px;
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 6px 28px 0 #a3b1c633, 0 2px 4px #a3b1c644;
      border: 1px solid #e6eaff;
      min-height: 70vh;
    }
    h1 {
      text-align: center;
      font-family: 'Montserrat', 'Segoe UI', Arial, sans-serif;
      font-size: 2.1em;
      margin-bottom: 18px;
      color: #373853;
      letter-spacing: 1px;
    }
    .tutorial {
      background: #f0f5ff;
      border: 1px solid #b9d3fa;
      border-radius: 12px;
      padding: 16px 22px 10px 22px;
      margin-bottom: 22px;
      font-size: 1.07em;
      color: #324a78;
      box-shadow: 0 1px 8px #b9d3fa22;
      line-height: 1.55;
    }
    .cloud-quiz-btn {
      background: linear-gradient(90deg, #59c7f3 0%, #91eac9 100%);
      color: #203447;
      border: none;
      border-radius: 7px;
      padding: 7px 22px;
      font-size: 1em;
      font-weight: 500;
      cursor: pointer;
      box-shadow: 0 2px 8px #59c7f333;
      transition: background 0.16s, box-shadow 0.16s;
      margin-bottom: 12px;
      margin-left: 0;
      margin-right: 13px;
      letter-spacing: 0.02em;
    }
    .cloud-quiz-btn:hover {
      background: linear-gradient(90deg, #23b6ea 0%, #47e4a1 100%);
      color: #fff;
    }
    .cloud-quiz-list {
      background: #f9fcff;
      border: 1px solid #b9d3fa;
      border-radius: 10px;
      padding: 18px 18px 10px 18px;
      margin-bottom: 18px;
      box-shadow: 0 1px 8px #b9d3fa22;
      font-size: 1.05em;
      color: #324a78;
    }
    .cloud-quiz-list ul {
      list-style: none;
      padding-left: 10px;
      margin: 0 0 8px 0;
    }
    .cloud-quiz-list li {
      margin: 3px 0 3px 0;
    }
    .cloud-quiz-list .folder {
      font-weight: bold;
      margin-top: 6px;
      color: #2a5d91;
    }
    .cloud-quiz-list .quiz-link {
      color: #1a4f7a;
      text-decoration: underline;
      cursor: pointer;
      background: none;
      border: none;
      font: inherit;
      padding: 2px 0;
      margin-left: 7px;
      transition: color 0.15s;
    }
    .cloud-quiz-list .quiz-link:hover {
      color: #0e866a;
      text-decoration: underline;
      background: #e0f7fa;
    }
    input[type="file"] {
      margin-bottom: 18px;
      padding: 6px 0;
      font-size: 1em;
      border: none;
      background: transparent;
    }
    .options-bar {
      display: flex; 
      gap: 10px; 
      margin-bottom: 18px; 
      justify-content: flex-start;
      flex-wrap: wrap;
      align-items: center;
    }
    .options-bar label {
      font-size: 1em;
      background: #f8fafd;
      border-radius: 8px;
      padding: 4px 10px 4px 7px;
      box-shadow: 0 1px 4px #0001;
      cursor: pointer;
      transition: background .2s;
      border: 1px solid #d3e1fa;
      margin-bottom: 2px;
    }
    .options-bar input[type="checkbox"] {
      margin-right: 6px;
    }
    #resetQuizBtn {
      background: linear-gradient(90deg, #f06d6d 0%, #ffb199 100%);
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 7px 22px;
      font-size: 1em;
      font-weight: 500;
      cursor: pointer;
      box-shadow: 0 2px 8px #f06d6d22;
      transition: background 0.16s, box-shadow 0.16s;
      margin-left: 8px;
      margin-bottom: 2px;
    }
    #resetQuizBtn:hover {
      background: linear-gradient(90deg, #d43a3a 0%, #ff7e5f 100%);
      box-shadow: 0 4px 18px #f06d6d33;
    }
    .question-block {
      margin-bottom: 35px;
      border-radius: 12px;
      border: 1px solid #e8e8f7;
      background: #f7f8fc;
      padding: 20px 20px 18px 20px;
      box-shadow: 0 2px 10px #cbd6f320;
      transition: box-shadow 0.15s;
    }
    .question-block:hover {
      box-shadow: 0 6px 18px #b3b9e833;
      border-color: #bacfff;
    }
    .question-block strong {
      color: #4b53b7;
      font-size: 1.09em;
      letter-spacing: 0.3px;
    }
    .alternatives {
      margin: 16px 0 0 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .enunciado {
      font-size: 1.3em;
      line-height: 1.4;
      margin-bottom: 2px;
      color: #313265;
    }
    .alternatives label {
      display: flex;
      align-items: flex-start;
      background: #fff;
      border-radius: 8px;
      border: 1px solid #dde2f7;
      font-size: 1.25em;
      padding: 7px 10px 7px 0;
      cursor: pointer;
      transition: background 0.15s, border 0.15s;
      min-height: 36px;
      user-select: none;
      position: relative;
      gap: 8px;
    }
    .alt-text-content {
      flex: 1 1 0;
      display: block;
      min-width: 0;
      word-break: break-word;
    }
    .alternatives label:hover {
      background: #e9f3ff;
      border-color: #adc9ff;
    }
    .alternatives input[type="radio"] {
      accent-color: #6b7cff;
      margin: 0 13px 0 7px;
      transform: scale(1.08);
    }
    .alt-elim-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 43px;
      height: 43px;
      margin-left: 8px;
      border-radius: 50%;
      background: #eef2f6;
      border: 1.5px solid #c6d7ee;
      color: #444;
      cursor: pointer;
      font-size: 1.13em;
      font-weight: bold;
      transition: background 0.15s, border 0.15s, color 0.13s;
      outline: none;
      user-select: none;
    }
    .alt-elim-btn:hover,
    .alt-elim-btn:focus {
      background: #e0e8f9;
      color: #0e866a;
      border-color: #91b6e6;
    }
    .eliminada {
      color: #b7b7b7 !important;
      text-decoration: line-through;
      font-style: italic;
      opacity: 0.8;
      transition: color 0.15s, opacity 0.15s;
    }
    .feedback {
      margin-top: 10px;
      font-weight: 500;
      min-height: 30px;
      border-radius: 8px;
      font-size: 1.1em;
      padding: 7px 12px 7px 12px;
      background: #f5f5fc;
      border: 1px solid #e5e7fb;
      margin-bottom: 4px;
    }
    .feedback.correct {
      color: #228b22;
      background: #e7fbe7;
      border-color: #b4eeb4;
    }
    .feedback.incorrect {
      color: #d5001a;
      background: #fff0f3;
      border-color: #f9b9c6;
    }
    .feedback.neutral {
      color: #3a3c50;
      background: #f4f6ff;
      border-color: #c2d8f9;
    }
    .write-block {
      margin-top: 18px;
      margin-bottom: 10px;
    }
    .write-block textarea {
      width: 100%;
      min-height: 54px;
      font-size: 1em;
      border-radius: 8px;
      border: 1px solid #adc9ff;
      background: #f9faff;
      padding: 7px 10px;
      resize: none;
      margin-bottom: 7px;
      font-family: inherit;
      transition: border 0.15s;
      overflow-y: hidden;
      box-sizing: border-box;
    }
    .write-block textarea:focus {
      outline: 2px solid #7a9afd;
      border-color: #7a9afd;
    }
    .send-btn {
      background: linear-gradient(90deg, #7a9afd 0%, #4f79e7 100%);
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 8px 24px;
      font-size: 1em;
      font-weight: 500;
      cursor: pointer;
      box-shadow: 0 2px 8px #adc9ff22;
      transition: background 0.16s;
      margin-bottom: 10px;
      margin-top: 4px;
      display: inline-block;
    }
    .send-btn:hover {
      background: linear-gradient(90deg, #4f79e7 0%, #7a9afd 100%);
    }
    .self-eval-block {
      margin-top: 6px;
      display: flex;
      flex-direction: row;
      gap: 8px;
      align-items: center;
      font-size: 1.01em;
      flex-wrap: wrap;
    }
    .self-eval-label {
      font-weight: 500;
      color: #445;
      margin-right: 8px;
    }
    .self-eval-btn {
      border: 1.5px solid #adc9ff;
      background: #ecf4fe;
      color: #4b53b7;
      border-radius: 5px;
      font-size: 1.08em;
      padding: 4px 13px;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.14s, border 0.14s, color 0.14s;
      margin-left: 0;
      margin-right: 0;
    }
    .self-eval-btn.selected,
    .self-eval-btn:hover {
      background: #7a9afd;
      color: #fff;
      border-color: #4f79e7;
    }
    #submitAll {
      display: none;
      margin-top: 10px;
      background: linear-gradient(90deg, #7a9afd 0%, #4f79e7 100%);
      color: #fff;
      border: none;
      border-radius: 9px;
      padding: 12px 32px;
      font-size: 1.12em;
      font-weight: 500;
      cursor: pointer;
      box-shadow: 0 2px 10px #a8b7ee33;
      transition: background 0.16s, box-shadow 0.16s;
      margin-left: 50%;
      transform: translateX(-50%);
    }
    #submitAll:hover {
      background: linear-gradient(90deg, #4f79e7 0%, #7a9afd 100%);
      box-shadow: 0 4px 18px #7a9afd33;
    }
    #score {
      font-size: 1.18em;
      font-weight: 600;
      text-align: center;
      margin-top: 28px;
      color: #373853;
      letter-spacing: 1px;
      background: #f1f5ff;
      border-radius: 10px;
      padding: 16px 0 14px 0;
      border: 1px solid #d3e1fa;
      box-shadow: 0 1px 8px #adc9ff22;
      max-width: 700px;
      margin-left: auto;
      margin-right: auto;
      white-space: pre-line;
    }
    @media (max-width: 700px) {
      #container { padding: 16px 2vw 12px 2vw; }
      .question-block { padding: 12px 3vw 10px 3vw; }
    }
    /* Estilo padrão para qualquer <img> no quiz */
    #quiz img {
      display: block;
      margin: 16px auto;
      max-width: 90%;
      max-height: 70vh;
      border-radius: 12px;
      cursor: zoom-in;
    }
    /* O “fundo escuro” do modal */
    #imgModal {
      display: none;
      position: fixed;
      z-index: 10000;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.8);
      justify-content: center;
      align-items: center;
    }
    #imgModal.open {
      display: flex;
    }
    /* A imagem dentro do modal */
    #imgModal img {
      margin: 10px auto 100px;
      width: auto;
      height: auto;
      max-width: 60%;
      max-height: 60%;
      transform: scale(1.5);
      transform-origin: center center;
      box-shadow: 0 0 24px #0008;
    }
  </style>
</head>
<body>
<div id="container">
  <h1>Quiz - Múltipla Escolha, V ou F e Escrita</h1>
  <div class="tutorial">
    <strong>Como usar:</strong><br>
    1. Importe o arquivo <strong>TXT</strong> contendo o quiz ou escolha um dos Quizes da Nuvem abaixo.<br>
    2. Por padrão, as opções <strong>aleatorizar questões</strong> e <strong>aleatorizar alternativas</strong> já estão marcadas.<br>
    3. Se preferir, <u>desmarque</u> essas opções para responder ao quiz na ordem original.<br>
    4. Clique em <b>Resetar Quiz</b> para reiniciar seu progresso com o quiz atual.<br>
    5. <b>Dica:</b> Nas questões de múltipla escolha, utilize o botão <span style="border-radius:50%;border:1.5px solid #c6d7ee;background:#eef2f6;padding:2px 5px;">✂️</span> ao lado de cada alternativa para "eliminar" opções que você não quer marcar.<br><br>
    <em>O quiz pode conter questões de múltipla escolha, V ou F e questões abertas (escrita).</em>
  </div>
  <div id="imgModal" onclick="closeImageModal()">
    <img id="imgModalImg" src="" alt="Clique para fechar">
  </div>
  <button class="cloud-quiz-btn" type="button" id="cloudQuizBtn">Quizes da Nuvem</button>
  <div id="cloudQuizList" class="cloud-quiz-list" style="display:none"></div>
  <input type="file" id="fileInput" accept=".txt" />
  <div class="options-bar">
    <label><input type="checkbox" id="shuffleQuestions" checked> Aleatorizar questões</label>
    <label><input type="checkbox" id="shuffleAlternatives" checked> Aleatorizar alternativas (apenas múltipla escolha)</label>
    <button id="resetQuizBtn" type="button">Resetar Quiz</button>
  </div>
  <div id="quiz"></div>
  <button id="submitAll">Enviar Todas as Respostas/Ver Nota Final</button>
  <div id="score"></div>
</div>
<script>
let cloudQuizData = null;
let shuffleQuestionsLocked = false; // NOVO: trava embaralhamento se q-random:false

fetch('quizes.json')
  .then((response) => response.json())
  .then((data) => { cloudQuizData = data; })
  .catch((err) => console.error('Erro ao carregar quizes.json:', err));

function renderCloudQuizList(tree) {
  function removeExtension(name) {
    return name.replace(/\.txt$/i, "");
  }
  function renderNode(node) {
    if (node.type === 'file') {
      return `<li><button class="quiz-link" data-path="${node.path}">${removeExtension(node.name)}</button></li>`;
    } else if (node.type === 'folder') {
      return `<li class="folder">${node.name}<ul>${node.children.map(renderNode).join("")}</ul></li>`;
    }
    return "";
  }
  return `<ul>${tree.map(renderNode).join("")}</ul>`;
}
const cloudQuizBtn = document.getElementById('cloudQuizBtn');
const cloudQuizListDiv = document.getElementById('cloudQuizList');
cloudQuizBtn.addEventListener('click', () => {
  if (cloudQuizListDiv.style.display === 'none') {
    if (cloudQuizData) {
      cloudQuizListDiv.innerHTML = renderCloudQuizList(cloudQuizData);
    } else {
      cloudQuizListDiv.innerHTML = "Carregando lista de quizzes...";
    }
    cloudQuizListDiv.style.display = 'block';
  } else {
    cloudQuizListDiv.style.display = 'none';
  }
});
cloudQuizListDiv.addEventListener('click', (e) => {
  if (e.target.classList.contains('quiz-link')) {
    const quizPath = e.target.getAttribute('data-path');
    fetch(quizPath)
      .then((res) => res.text())
      .then((text) => {
        processQuizText(text);
      });
    cloudQuizListDiv.style.display = 'none';
  }
});

function addEliminationButton(label) {
  const btn = document.createElement('button');
  btn.type = "button";
  btn.className = "alt-elim-btn";
  btn.title = "Eliminar/Restaurar alternativa";
  btn.tabIndex = 0;
  btn.innerText = "✂️";
  btn.setAttribute("aria-label", "Eliminar alternativa");
  btn.addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    label.classList.toggle('eliminada');
  });
  label.appendChild(btn);
}

function autoEmbedImages(text) {
  if (!text) return "";
  return text.replace(
    /(https?:\/\/\S+\.(?:png|jpe?g|gif|webp))/gi,
    '<img src="$1">'
  );
}

function formatComentarioLetraShuffle(comentario, altOrder) {
  if (!comentario) return "";
  let letraMap = {};
  for (let i = 0; i < altOrder.length; i++) {
    letraMap[altOrder[i]] = String.fromCharCode(65 + i);
  }
  return comentario.replace(/\{([A-E])\}/g, (m, letra) => {
    if (letraMap[letra]) return `<strong>${letraMap[letra]}</strong>`;
    return m;
  });
}

function parseQuestions(text) {
  const blocks = text.split(/\n\s*\n|^-{3,}$/m)
    .map(b => b.trim())
    .filter(Boolean);
  const questions = [];
  for (const block of blocks) {
    const openQ = block.match(/^Q:\s*([\s\S]+?)^\s*GABARITO:\s*([\s\S]+)$/m);
    if (openQ) {
      const rawEnunciado = openQ[1].trim();
      const enunciado = autoEmbedImages(rawEnunciado);
      questions.push({
        tipo: 'escrita',
        enunciado,
        gabarito: openQ[2].trim()
      });
      continue;
    }
    const qMatch = block.match(/^Q:\s*([\s\S]+?)(?=^([A-E]\)|G:))/m);
    if (!qMatch) continue;
    const rawEnunciado = qMatch[1].trim();
    const enunciado = autoEmbedImages(rawEnunciado);
    const gMatch = block.match(/^G:\s*([A-EVF])$/m);
    if (!gMatch) continue;
    const gabarito = gMatch[1];
    const cmtMatch = block.match(/^C:\s*([\s\S]+)$/m);
    const rawComentario = cmtMatch ? cmtMatch[1].trim() : "";
    const comentario = rawComentario ? autoEmbedImages(rawComentario) : null;
    const altRegex = /^([A-E])\)\s*([\s\S]+?)(?=^[A-E]\)|^G:|^C:|^$)/gm;
    const alternativas = [];
    let match;
    while ((match = altRegex.exec(block)) !== null) {
      alternativas.push({
        letra: match[1],
        texto: match[2].trim().replace(/\n/g, ' ')
      });
    }
    if (alternativas.length >= 3 && alternativas.length <= 5) {
      questions.push({
        tipo: 'me',
        enunciado,
        alternativas,
        gabarito,
        comentario
      });
    } else if (
      (alternativas.length === 0 ||
      (alternativas.length === 2 &&
       ((alternativas[0].letra === 'A' && /verdadeiro/i.test(alternativas[0].texto) &&
         alternativas[1].letra === 'B' && /falso/i.test(alternativas[1].texto)) ||
        (alternativas[1].letra === 'A' && /verdadeiro/i.test(alternativas[1].texto) &&
         alternativas[0].letra === 'B' && /falso/i.test(alternativas[0].texto))))
      )
    ) {
      questions.push({
        tipo: 'vf',
        enunciado,
        gabarito,
        comentario
      });
    }
  }
  return questions;
}

const STORAGE_KEY = "quiz-txt-app-state-v1";
function saveState(state) {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  } catch(e){}
}
function loadState() {
  try {
    return JSON.parse(localStorage.getItem(STORAGE_KEY));
  } catch(e){ return null; }
}
function clearState() {
  try {
    localStorage.removeItem(STORAGE_KEY);
  } catch(e){}
}

let originalQuestions = [];
let questions = [];
let userAnswers = [];
let tempAnswers = [];
let scoreME = 0;
let scoreVF = 0;
let scoreEscrita = 0;
let shuffledQuestionsOrder = [];
let shuffledAlternativesOrders = [];
let escritaAutoNotas = [];
let quizTextHash = "";

const fileInput = document.getElementById('fileInput');
const shuffleQuestionsChk = document.getElementById('shuffleQuestions');
const shuffleAlternativesChk = document.getElementById('shuffleAlternatives');
const resetQuizBtn = document.getElementById('resetQuizBtn');

// NOVO: processa o texto e bloqueia embaralhamento se q-random: false;
function processQuizText(fileText) {
  shuffleQuestionsLocked = false;
  const lines = fileText.split(/\r?\n/);
  if (lines.length && /^q-random:\s*false;?/i.test(lines[0].trim())) {
    shuffleQuestionsLocked = true;
    shuffleQuestionsChk.checked = false;
    shuffleQuestionsChk.disabled = true;
    shuffleQuestionsChk.parentElement.style.opacity = 0.6;
    lines.shift(); // remove instrução da entrada do quiz
    fileText = lines.join("\n");
  } else {
    shuffleQuestionsChk.disabled = false;
    shuffleQuestionsChk.parentElement.style.opacity = 1;
  }
  originalQuestions = parseQuestions(fileText);
  quizTextHash = simpleHash(fileText);
  shuffledQuestionsOrder = [];
  shuffledAlternativesOrders = [];
  userAnswers = [];
  tempAnswers = [];
  scoreME = scoreVF = scoreEscrita = 0;
  setupQuiz();
  saveCurrentState(fileText);
}

function simpleHash(str) {
  let hash = 0, i, chr;
  if (str.length === 0) return hash.toString();
  for (i = 0; i < str.length; i++) {
    chr = str.charCodeAt(i);
    hash = ((hash << 5) - hash) + chr;
    hash |= 0;
  }
  return hash.toString();
}

window.addEventListener("DOMContentLoaded", function() {
  const state = loadState();
  if (state && state.quizText && state.quizTextHash) {
    let fileText = state.quizText;
    // NOVO: detecta q-random: false; salvo no localStorage
    shuffleQuestionsLocked = false;
    const lines = fileText.split(/\r?\n/);
    if (lines.length && /^q-random:\s*false;?/i.test(lines[0].trim())) {
      shuffleQuestionsLocked = true;
      shuffleQuestionsChk.checked = false;
      shuffleQuestionsChk.disabled = true;
      shuffleQuestionsChk.parentElement.style.opacity = 0.6;
      lines.shift();
      fileText = lines.join("\n");
    } else {
      shuffleQuestionsChk.disabled = false;
      shuffleQuestionsChk.parentElement.style.opacity = 1;
    }
    const parsed = parseQuestions(fileText);
    if (parsed.length) {
      originalQuestions = parsed;
      quizTextHash = state.quizTextHash;
      shuffledQuestionsOrder = state.shuffledQuestionsOrder || [...Array(parsed.length).keys()];
      shuffledAlternativesOrders = state.shuffledAlternativesOrders || [];
      questions = shuffledQuestionsOrder.map(idx => originalQuestions[idx]);
      userAnswers = state.userAnswers || Array(questions.length).fill(null);
      tempAnswers = state.tempAnswers || Array(questions.length).fill(null);
      escritaAutoNotas = state.escritaAutoNotas || Array(questions.length).fill(null);
      scoreME = state.scoreME || 0;
      scoreVF = state.scoreVF || 0;
      scoreEscrita = state.scoreEscrita || 0;
      shuffleQuestionsChk.checked = !!state.shuffleQuestions;
      shuffleAlternativesChk.checked = !!state.shuffleAlternatives;
      document.getElementById('score').textContent = '';
      renderQuiz();
      return;
    }
  }
});

fileInput.addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(ev) {
    processQuizText(ev.target.result);
  };
  reader.readAsText(file, 'utf-8');
});

resetQuizBtn.addEventListener('click', function() {
  if (!originalQuestions.length) return;
  setupQuiz();
  saveCurrentState();
});
shuffleQuestionsChk.addEventListener('change', function() {
  if (shuffleQuestionsLocked) {
    shuffleQuestionsChk.checked = false;
    return;
  }
  setupQuiz();
  saveCurrentState();
});
shuffleAlternativesChk.addEventListener('change', function() {
  setupQuiz();
  saveCurrentState();
});

function setupQuiz() {
  if (!originalQuestions.length) {
    document.getElementById('quiz').innerHTML = "<div style='text-align:center;color:#b22;font-size:1.1em;font-weight:600'>Nenhuma questão válida encontrada.<br>Verifique o formato do arquivo.</div>";
    document.getElementById('submitAll').style.display = 'none';
    document.getElementById('score').textContent = '';
    return;
  }
  if (shuffleQuestionsChk.checked) {
    shuffledQuestionsOrder = shuffleArray([...Array(originalQuestions.length).keys()]);
  } else {
    shuffledQuestionsOrder = [...Array(originalQuestions.length).keys()];
  }
  shuffledAlternativesOrders = [];
  for (let qidx = 0; qidx < originalQuestions.length; qidx++) {
    if (originalQuestions[qidx].tipo === 'me') {
      const alts = originalQuestions[qidx].alternativas.map(alt => alt.letra);
      if (shuffleAlternativesChk.checked) {
        shuffledAlternativesOrders[qidx] = shuffleArray(alts);
      } else {
        shuffledAlternativesOrders[qidx] = alts;
      }
    } else {
      shuffledAlternativesOrders[qidx] = null;
    }
  }
  questions = shuffledQuestionsOrder.map(idx => originalQuestions[idx]);
  userAnswers = Array(questions.length).fill(null);
  tempAnswers = Array(questions.length).fill(null);
  escritaAutoNotas = Array(questions.length).fill(null);
  scoreME = 0;
  scoreVF = 0;
  scoreEscrita = 0;
  document.getElementById('score').textContent = '';
  renderQuiz();
  saveCurrentState();
}

function saveCurrentState(quizTextOverride) {
  const state = {
    quizText: quizTextOverride !== undefined ? quizTextOverride : null,
    quizTextHash: quizTextHash,
    shuffledQuestionsOrder,
    shuffledAlternativesOrders,
    userAnswers,
    tempAnswers,
    escritaAutoNotas,
    scoreME,
    scoreVF,
    scoreEscrita,
    shuffleQuestions: shuffleQuestionsChk.checked,
    shuffleAlternatives: shuffleAlternativesChk.checked
  };
  if (!state.quizText) {
    if (originalQuestions.length && quizTextHash) {
      const prev = loadState();
      if (prev && prev.quizTextHash === quizTextHash) {
        state.quizText = prev.quizText;
      }
    }
  }
  if (quizTextOverride !== undefined) {
    state.quizText = quizTextOverride;
  }
  saveState(state);
}

function renderQuiz() {
  const quizDiv = document.getElementById('quiz');
  quizDiv.innerHTML = '';
  questions.forEach((q, idx) => {
    const block = document.createElement('div');
    block.className = 'question-block';
    block.innerHTML += `<div class="enunciado"><strong>${idx+1}.</strong> ${q.enunciado.replace(/\n/g, '<br>')}</div>`;
    if (q.tipo === 'me') {
      const altDiv = document.createElement('div');
      altDiv.className = 'alternatives';
      const origIdx = shuffledQuestionsOrder[idx];
      const altOrder = shuffledAlternativesOrders[origIdx];
      altOrder.forEach((letra, i) => {
        const alt = q.alternativas.find(a => a.letra === letra);
        const visLetra = String.fromCharCode(65 + i);
        const label = document.createElement('label');
        label.innerHTML = `<input type="radio" name="q${idx}" value="${letra}">
          <strong>${visLetra})</strong>
          <span class="alt-text-content">${alt ? alt.texto : ''}</span>`;
        addEliminationButton(label);
        altDiv.appendChild(label);
      });
      block.appendChild(altDiv);
      const radios = block.querySelectorAll(`input[type="radio"][name="q${idx}"]`);
      radios.forEach(r => {
        if (tempAnswers[idx] && r.value === tempAnswers[idx] && userAnswers[idx] === null) {
          r.checked = true;
        }
        r.addEventListener('change', () => {
          if (userAnswers[idx] === null) {
            tempAnswers[idx] = r.value;
            saveCurrentState();
          }
        });
      });
      const sendBtn = document.createElement('button');
      sendBtn.className = 'send-btn';
      sendBtn.textContent = 'Enviar Resposta';
      sendBtn.type = "button";
      sendBtn.addEventListener('click', () => {
        const selected = tempAnswers[idx] || "";
        checkAnswer(idx, selected, null);
        radios.forEach(r => r.disabled = true);
        sendBtn.disabled = true;
        sendBtn.style.opacity = 0.6;
        sendBtn.style.cursor = 'not-allowed';
        userAnswers[idx] = selected;
        saveCurrentState();
      });
      block.appendChild(sendBtn);
      const feedback = document.createElement('div');
      feedback.className = 'feedback';
      feedback.id = `feedback${idx}`;
      block.appendChild(feedback);
    } else if (q.tipo === 'vf') {
      const altDiv = document.createElement('div');
      altDiv.className = 'alternatives';
      const vfAlts = [
        { letra: 'V', texto: 'Verdadeiro' },
        { letra: 'F', texto: 'Falso' }
      ];
      vfAlts.forEach((alt, i) => {
        const label = document.createElement('label');
        label.innerHTML = `<input type="radio" name="q${idx}" value="${alt.letra}"> <strong>${alt.letra})</strong> ${alt.texto}`;
        altDiv.appendChild(label);
      });
      block.appendChild(altDiv);
      const radios = block.querySelectorAll(`input[type="radio"][name="q${idx}"]`);
      radios.forEach(r => {
        if (tempAnswers[idx] && r.value === tempAnswers[idx] && userAnswers[idx] === null) {
          r.checked = true;
        }
        r.addEventListener('change', () => {
          if (userAnswers[idx] === null) {
            tempAnswers[idx] = r.value;
            saveCurrentState();
          }
        });
      });
      const sendBtn = document.createElement('button');
      sendBtn.className = 'send-btn';
      sendBtn.textContent = 'Enviar Resposta';
      sendBtn.type = "button";
      sendBtn.addEventListener('click', () => {
        const selected = tempAnswers[idx] || "";
        checkAnswer(idx, selected, null);
        radios.forEach(r => r.disabled = true);
        sendBtn.disabled = true;
        sendBtn.style.opacity = 0.6;
        sendBtn.style.cursor = 'not-allowed';
        userAnswers[idx] = selected;
        saveCurrentState();
      });
      block.appendChild(sendBtn);
      const feedback = document.createElement('div');
      feedback.className = 'feedback';
      feedback.id = `feedback${idx}`;
      block.appendChild(feedback);
    } else if (q.tipo === 'escrita') {
      const writeDiv = document.createElement('div');
      writeDiv.className = 'write-block';
      const textarea = document.createElement('textarea');
      textarea.id = `escrita-input-${idx}`;
      if (userAnswers[idx] !== null) {
        textarea.value = userAnswers[idx];
      } else if (tempAnswers[idx]) {
        textarea.value = tempAnswers[idx];
      }
      textarea.placeholder = "Digite sua resposta aqui...";
      textarea.autocomplete = "off";
      textarea.spellcheck = true;
      textarea.addEventListener('input', (e) => {
        if (userAnswers[idx] === null) {
          tempAnswers[idx] = e.target.value;
          autoGrow(e);
          saveCurrentState();
        }
      });
      const sendBtn = document.createElement('button');
      sendBtn.className = 'send-btn';
      sendBtn.textContent = 'Enviar Resposta';
      sendBtn.type = "button";
      sendBtn.addEventListener('click', () => {
        enviarRespostaEscrita(idx);
        saveCurrentState();
      });
      writeDiv.appendChild(textarea);
      writeDiv.appendChild(sendBtn);
      block.appendChild(writeDiv);
      const feedback = document.createElement('div');
      feedback.className = 'feedback neutral';
      feedback.id = `feedback${idx}`;
      feedback.style.display = 'none';
      block.appendChild(feedback);
      const selfEvalDiv = document.createElement('div');
      selfEvalDiv.className = 'self-eval-block';
      selfEvalDiv.id = `selfeval-${idx}`;
      selfEvalDiv.style.display = 'none';
      const evalLabel = document.createElement('span');
      evalLabel.className = 'self-eval-label';
      evalLabel.textContent = 'Autoavaliação:';
      selfEvalDiv.appendChild(evalLabel);
      for (let i = 0; i <= 5; i++) {
        const btn = document.createElement('button');
        btn.className = 'self-eval-btn';
        btn.textContent = i;
        btn.setAttribute('data-value', i);
        btn.type = "button";
        btn.addEventListener('click', () => {
          avaliarEscrita(idx, i);
          saveCurrentState();
        });
        selfEvalDiv.appendChild(btn);
      }
      block.appendChild(selfEvalDiv);
    }
    quizDiv.appendChild(block);
  });

  questions.forEach((q, idx) => {
    if (userAnswers[idx] !== null) {
      if (q.tipo === 'me' || q.tipo === 'vf') {
        const radios = document.getElementsByName(`q${idx}`);
        radios.forEach(r => {
          if (r.value === userAnswers[idx]) r.checked = true;
          r.disabled = true;
        });
        checkAnswer(idx, userAnswers[idx], null, true);
        const btn = radios[0] ? radios[0].closest('.question-block').querySelector('.send-btn') : null;
        if (btn) {
          btn.disabled = true;
          btn.style.opacity = 0.6;
          btn.style.cursor = 'not-allowed';
        }
      } else if (q.tipo === 'escrita') {
        const textarea = document.getElementById(`escrita-input-${idx}`);
        textarea.value = userAnswers[idx];
        autoGrow({target: textarea});
        textarea.disabled = true;
        textarea.style.background = '#e1e6f8';
        textarea.style.borderColor = '#adc9ff';
        const sendBtn = textarea.nextSibling;
        sendBtn.disabled = true;
        sendBtn.style.opacity = 0.6;
        sendBtn.style.cursor = 'not-allowed';
        const feedback = document.getElementById(`feedback${idx}`);
        feedback.innerHTML = `<strong>Gabarito:</strong><br>${questions[idx].gabarito.replace(/\n/g, '<br>')}`;
        feedback.className = 'feedback neutral';
        feedback.style.display = 'block';
        if (escritaAutoNotas[idx] !== null) {
          const selfEvalDiv = document.getElementById(`selfeval-${idx}`);
          selfEvalDiv.style.display = 'flex';
          const buttons = selfEvalDiv.querySelectorAll('.self-eval-btn');
          buttons.forEach(btn => {
            btn.classList.toggle('selected', Number(btn.getAttribute('data-value')) === escritaAutoNotas[idx]);
          });
        }
      }
    }
  });

  document.getElementById('submitAll').style.display = questions.length ? 'block' : 'none';
}

function autoGrow(e) {
  const el = e.target;
  el.style.height = 'auto';
  el.style.height = (el.scrollHeight) + 'px';
}

function checkAnswer(qIdx, selectedLetra, visIdx, restoring) {
  if (userAnswers[qIdx] === null && !restoring) userAnswers[qIdx] = (selectedLetra === null ? "" : selectedLetra);
  const question = questions[qIdx];
  const feedback = document.getElementById(`feedback${qIdx}`);
  if (!feedback) return;
  if (question.tipo === 'me') {
    const origIdx = shuffledQuestionsOrder[qIdx];
    const altOrder = shuffledAlternativesOrders[origIdx];
    const correctLetra = question.gabarito;
    const isCorrect = (userAnswers[qIdx] === correctLetra);
    const correctIdx = altOrder.indexOf(correctLetra);
    const correctAlt = question.alternativas.find(a => a.letra === correctLetra);
    if (isCorrect) {
      feedback.innerHTML = 'Correto!';
      if (question.comentario) {
        feedback.innerHTML += '<br>' + formatComentarioLetraShuffle(question.comentario, altOrder).replace(/\n/g, '<br>');
      }
      feedback.className = 'feedback correct';
      if (!restoring) scoreME++;
    } else {
      feedback.innerHTML = `Errado! Resposta: <strong>${String.fromCharCode(65+correctIdx)})</strong> ${correctAlt ? correctAlt.texto : ''}.`;
      if (question.comentario) {
        feedback.innerHTML += '<br>' + formatComentarioLetraShuffle(question.comentario, altOrder).replace(/\n/g, '<br>');
      }
      feedback.className = 'feedback incorrect';
    }
  } else if (question.tipo === 'vf') {
    const isCorrect = (userAnswers[qIdx] === question.gabarito);
    if (isCorrect) {
      feedback.innerHTML = 'Correto!';
      if (question.comentario) {
        feedback.innerHTML += '<br>' + question.comentario.replace(/\n/g, '<br>');
      }
      feedback.className = 'feedback correct';
      if (!restoring) scoreVF++;
    } else {
      const correctText = question.gabarito === 'V' ? 'Verdadeiro' : 'Falso';
      feedback.innerHTML = `Errado! Resposta: <strong>${question.gabarito})</strong> ${correctText}.`;
      if (question.comentario) {
        feedback.innerHTML += '<br>' + question.comentario.replace(/\n/g, '<br>');
      }
      feedback.className = 'feedback incorrect';
    }
  }
  if (!restoring && isQuizFinished()) showScore();
}

document.getElementById('submitAll').addEventListener('click', () => {
  questions.forEach((q, idx) => {
    if (q.tipo === 'me' || q.tipo === 'vf') {
      if (userAnswers[idx] === null) {
        const radios = document.getElementsByName(`q${idx}`);
        let selected = null;
        radios.forEach(r => { if (r.checked) selected = r.value; });
        checkAnswer(idx, selected, null);
        radios.forEach(r => r.disabled = true);
        const btn = radios[0] ? radios[0].closest('.question-block').querySelector('.send-btn') : null;
        if (btn) {
          btn.disabled = true;
          btn.style.opacity = 0.6;
          btn.style.cursor = 'not-allowed';
        }
      }
    } else if (q.tipo === 'escrita') {
      const textarea = document.getElementById(`escrita-input-${idx}`);
      if (userAnswers[idx] === null) enviarRespostaEscrita(idx);
    }
  });
  showScore();
});

function enviarRespostaEscrita(qIdx) {
  if (userAnswers[qIdx] !== null) return;
  const textarea = document.getElementById(`escrita-input-${qIdx}`);
  const resposta = textarea.value.trim();
  userAnswers[qIdx] = resposta;
  const feedback = document.getElementById(`feedback${qIdx}`);
  feedback.innerHTML = `<strong>Gabarito:</strong><br>${questions[qIdx].gabarito.replace(/\n/g, '<br>')}`;
  feedback.className = 'feedback neutral';
  feedback.style.display = 'block';
  textarea.disabled = true;
  textarea.style.background = '#e1e6f8';
  textarea.style.borderColor = '#adc9ff';
  const sendBtn = textarea.nextSibling;
  sendBtn.disabled = true;
  sendBtn.style.opacity = 0.6;
  sendBtn.style.cursor = 'not-allowed';
  const selfEvalDiv = document.getElementById(`selfeval-${qIdx}`);
  selfEvalDiv.style.display = 'flex';
  avaliarEscrita(qIdx, 0);
}

function avaliarEscrita(qIdx, nota) {
  escritaAutoNotas[qIdx] = nota;
  const selfEvalDiv = document.getElementById(`selfeval-${qIdx}`);
  const buttons = selfEvalDiv.querySelectorAll('.self-eval-btn');
  buttons.forEach(btn => {
    btn.classList.toggle('selected', Number(btn.getAttribute('data-value')) === nota);
  });
  if (isQuizFinished()) showScore();
}

function isQuizFinished() {
  for (let i = 0; i < questions.length; ++i) {
    if (questions[i].tipo === 'escrita') {
      if (userAnswers[i] === null || escritaAutoNotas[i] === null) return false;
    } else {
      if (userAnswers[i] === null) return false;
    }
  }
  return true;
}

function showScore() {
  let totalME = 0, totalVF = 0, totalEscrita = 0, pontosEscrita = 0;
  questions.forEach((q, idx) => {
    if (q.tipo === 'me') totalME++;
    else if (q.tipo === 'vf') totalVF++;
    else if (q.tipo === 'escrita') {
      totalEscrita++;
      const nota = escritaAutoNotas[idx];
      if (Number.isInteger(nota) && nota >= 0 && nota <= 5) {
        pontosEscrita += nota / 5;
      }
    }
  });
  let notaME = totalME ? ((scoreME / totalME) * 10).toFixed(2) : "--";
  let notaVF = totalVF ? ((scoreVF / totalVF) * 10).toFixed(2) : "--";
  let notaEscrita = totalEscrita ? ((pontosEscrita / totalEscrita) * 10).toFixed(2) : "--";
  let notaGeral = (totalME + totalVF + totalEscrita) ?
    (((scoreME + scoreVF + pontosEscrita) / (totalME + totalVF + totalEscrita)) * 10).toFixed(2)
    : "--";
  let relatorio =
    `Relatório de Notas:\n` +
    `Múltipla escolha: ${notaME} / 10 (${scoreME} de ${totalME} acertos)\n` +
    `V ou F:           ${notaVF} / 10 (${scoreVF} de ${totalVF} acertos)\n` +
    `Escrita:          ${notaEscrita} / 10 (${pontosEscrita.toFixed(2)} de ${totalEscrita} pontos possíveis)\n` +
    `Geral:            ${notaGeral} / 10 (${(scoreME + scoreVF + pontosEscrita).toFixed(2)} de ${(totalME + totalVF + totalEscrita)} acertos/pontos)`;
  document.getElementById('score').textContent = relatorio;
  saveCurrentState();
}

function shuffleArray(arr) {
  const a = arr.slice();
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i+1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}
</script>
<script>
function openImageModal(src) {
  const modal = document.getElementById('imgModal');
  const img = document.getElementById('imgModalImg');
  img.src = src;
  modal.classList.add('open');
}
function closeImageModal() {
  document.getElementById('imgModal').classList.remove('open');
}
document.getElementById('quiz').addEventListener('click', function(e) {
  if (e.target.tagName.toLowerCase() === 'img') {
    openImageModal(e.target.src);
  }
});
function attachImageFullscreenListeners() {
  document.querySelectorAll('#quiz img').forEach(img => {
    img.onclick = null;
    img.addEventListener('click', () => openImageModal(img.src));
  });
}
</script>
</body>
</html>
